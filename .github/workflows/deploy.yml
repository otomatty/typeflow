# Cloudflareへの自動デプロイワークフロー
name: Deploy to Cloudflare

on:
  # mainブランチへのプッシュ時に実行
  push:
    branches: [main]
  # 手動実行も可能に
  workflow_dispatch:

# 同時実行を制御（1つのデプロイのみ実行）
concurrency:
  group: deploy-cloudflare
  cancel-in-progress: false

jobs:
  # バックエンド（Cloudflare Workers）のデプロイ
  # ⚠️ 重要: このジョブは wrangler.toml を使用してWorkersにデプロイします
  # フロントエンドは deploy-pages ジョブで別途デプロイされます
  deploy-workers:
    name: Deploy to Cloudflare Workers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run type check
        run: bun run typecheck

      # wrangler.toml を使用してWorkersにデプロイ（バックエンドAPIのみ）
      # フロントエンドは deploy-pages ジョブでデプロイされます
      # 
      # --keep-vars: Cloudflare Dashboardで設定した環境変数を保持する
      # （これがないと、デプロイのたびにDashboardで設定した環境変数がリセットされる）
      # 注意: シークレットは--keep-varsに関係なく常に保持される
      - name: Deploy to Cloudflare Workers
        run: bunx wrangler deploy --keep-vars
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Health check
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 15
          
          # Workers URLを取得（wrangler.tomlのnameから推測、または環境変数から）
          WORKER_NAME="typeflow-api"
          WORKER_URL="https://${WORKER_NAME}.${{ secrets.CLOUDFLARE_SUBDOMAIN }}.workers.dev"
          
          # 環境変数でURLが指定されている場合はそれを使用
          if [ -n "${{ secrets.CLOUDFLARE_WORKER_URL }}" ]; then
            WORKER_URL="${{ secrets.CLOUDFLARE_WORKER_URL }}"
          fi
          
          echo "Checking health endpoint: ${WORKER_URL}/health"
          
          # ヘルスチェック（最大3回リトライ）
          MAX_RETRIES=3
          RETRY_COUNT=0
          HTTP_CODE=000
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${WORKER_URL}/health" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Health check passed (HTTP $HTTP_CODE)"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "⚠️ Health check failed (HTTP $HTTP_CODE), retrying in 5 seconds... ($RETRY_COUNT/$MAX_RETRIES)"
              sleep 5
            fi
          done
          
          echo "⚠️ Health check failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
          echo "This might be expected if the worker URL is different or deployment is still propagating"
          # ヘルスチェック失敗でもデプロイは続行（警告のみ）

  # フロントエンド（Cloudflare Pages）のデプロイ
  # ⚠️ 重要: このジョブは cloudflare/pages-action を使用してPagesにデプロイします
  # wrangler.toml は使用しません（Workers用の設定ファイルです）
  deploy-pages:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: deploy-workers
    # GitHub Deploymentsを作成するために必要な権限
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}

      # cloudflare/pages-action を使用してPagesにデプロイ（フロントエンドのみ）
      # wrangler.toml は使用しません
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: typeflow
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
