# PRD: マルチユーザー対応機能 (Multi-User Support)

## 1. 製品概要と背景

### 1.1 背景

TypeFlowは現在、シングルユーザー前提の設計となっており、クラウドデータベース（Turso）を使用しているものの、ユーザー認証やユーザー管理機能が実装されていません。これにより、以下の問題が発生しています：

- **データ分離の欠如**: 複数のユーザーが同じデータベースを使用する場合、データが混在してしまう
- **セキュリティリスク**: ユーザー間でデータが共有され、プライバシーが保護されない
- **スケーラビリティの制限**: マルチユーザー環境での運用が不可能
- **データ損失リスク**: ユーザー固有のデータを識別・復元できない

### 1.2 目標

本PRDでは、TypeFlowにマルチユーザー対応機能を追加し、以下の目標を達成します：

1. **ユーザー認証システムの実装**: 安全で使いやすい認証フロー
2. **データ分離の実現**: ユーザーごとにデータを完全に分離
3. **既存ユーザーへの配慮**: 既存のローカルデータをクラウドに移行可能にする
4. **シームレスな体験**: 認証プロセスを最小限に抑え、既存のUXを維持

### 1.3 スコープ

- **含まれるもの**:
  - ユーザー認証（サインアップ、ログイン、ログアウト）
  - ユーザー管理（プロフィール、アカウント設定）
  - データのユーザー紐付け
  - ローカルデータのクラウド移行
  - セッション管理

- **含まれないもの（将来対応）**:
  - ソーシャルログイン（OAuth、Google、GitHub等）
  - パスワードリセット機能
  - メール認証
  - 2要素認証（2FA）
  - ユーザー間のデータ共有機能

---

## 2. 現状の問題点と課題

### 2.1 データベーススキーマの問題

現在のデータベースには以下の問題があります：

| テーブル           | 問題点                                     |
| ------------------ | ------------------------------------------ |
| `words`            | `user_id`カラムが存在しない                |
| `aggregated_stats` | ユーザーごとの統計が分離されていない       |
| `settings`         | 全ユーザーで設定が共有される               |
| `game_scores`      | スコア履歴がユーザーごとに分離されていない |
| `user_presets`     | ユーザープリセットが全ユーザーで共有される |
| `presets`          | システムプリセット（これは共有で問題なし） |

### 2.2 認証システムの欠如

- `src/server/auth.ts` はスケルトンのみで実装されていない
- 認証ミドルウェアが常に `user: null` を返す
- APIエンドポイントでユーザーIDによるフィルタリングが行われていない

### 2.3 セキュリティリスク

- 認証なしで全ユーザーのデータにアクセス可能
- データの改ざん・削除リスク
- プライバシー侵害の可能性

---

## 3. 機能要件

### 3.1 ユーザー認証機能

#### 3.1.1 サインアップ（新規登録）

**要件**:

- ユーザー名（必須、3-30文字、英数字とアンダースコアのみ）
- メールアドレス（必須、有効なメール形式）
- パスワード（必須、8文字以上、英数字と記号を含む）
- パスワード確認（必須、パスワードと一致）

**バリデーション**:

- ユーザー名の重複チェック
- メールアドレスの重複チェック
- パスワード強度チェック

**フロー**:

1. ユーザーがサインアップ画面で情報を入力
2. フロントエンドでバリデーション
3. バックエンドAPIに送信
4. サーバー側で再度バリデーション
5. パスワードをハッシュ化（bcrypt）
6. ユーザーレコードを作成
7. 認証トークン（JWT）を発行
8. クライアントにトークンを返却（HTTP-only CookieまたはLocalStorage）

#### 3.1.2 ログイン

**要件**:

- ユーザー名またはメールアドレスでログイン可能
- パスワード認証
- 「ログイン状態を保持する」オプション（30日間有効）

**フロー**:

1. ユーザーがログイン情報を入力
2. バックエンドで認証情報を検証
3. パスワードを検証（bcrypt）
4. JWTトークンを発行
5. クライアントにトークンを返却

#### 3.1.3 ログアウト

**要件**:

- 現在のセッションを無効化
- クライアント側のトークンを削除
- サーバー側のセッション情報を削除（オプション）

#### 3.1.4 認証状態の確認

**要件**:

- アプリ起動時に認証状態を確認
- トークンの有効性を検証
- 無効なトークンの場合は自動ログアウト

### 3.2 ユーザー管理機能

#### 3.2.1 プロフィール管理

**表示情報**:

- ユーザー名
- メールアドレス
- 登録日時
- 最終ログイン日時
- 統計サマリー（総プレイ回数、総単語数など）

**編集可能情報**:

- ユーザー名（変更時は重複チェック）
- メールアドレス（変更時は確認メール送信）

#### 3.2.2 アカウント設定

- テーマ設定（既存機能をユーザーごとに保存）
- 通知設定（将来対応）
- データエクスポート機能
- アカウント削除機能

### 3.3 データ分離機能

#### 3.3.1 ユーザー固有データの取得

すべてのAPIエンドポイントで、認証されたユーザーのIDに基づいてデータをフィルタリング：

- `GET /api/words` → ログインユーザーの単語のみ
- `GET /api/stats` → ログインユーザーの統計のみ
- `GET /api/settings` → ログインユーザーの設定のみ
- `GET /api/scores` → ログインユーザーのスコアのみ
- `GET /api/user-presets` → ログインユーザーのプリセットのみ

#### 3.3.2 データ作成時のユーザー紐付け

すべてのデータ作成時に、自動的に現在のユーザーIDを紐付け：

- 単語追加時
- スコア保存時
- 設定更新時
- ユーザープリセット作成時

### 3.4 データ移行機能

#### 3.4.1 ローカルデータのクラウド移行

既存のローカルデータ（IndexedDB）をクラウドに移行する機能：

**フロー**:

1. ユーザーがログイン後、移行オプションを表示
2. ローカルデータを読み込み
3. データをバックエンドAPIに送信
4. バックエンドでユーザーIDを紐付け
5. 移行完了を通知
6. オプション: ローカルデータをクリア

**移行対象データ**:

- 単語リスト（words）
- 統計データ（aggregated_stats）
- 設定（settings）
- ゲームスコア（game_scores）
- ユーザープリセット（user_presets）

#### 3.4.2 データ同期

- オフライン時のデータをオンライン時に同期
- 競合解決（Last-Write-Wins方式）

---

## 4. 技術要件

### 4.1 認証方式

**JWT（JSON Web Token）ベース認証**:

- トークンの有効期限: 24時間（通常）、30日（「ログイン状態を保持」）
- リフレッシュトークン: 将来対応
- トークン署名: HS256（HMAC-SHA256）

**セキュリティ対策**:

- パスワードハッシュ化: bcrypt（コストファクター: 10）
- HTTPS必須（本番環境）
- CSRF対策: SameSite Cookie属性
- XSS対策: HTTP-only Cookieの使用を検討

### 4.2 データベーススキーマ変更

#### 4.2.1 新規テーブル

**users テーブル**:

```sql
CREATE TABLE IF NOT EXISTS users (
  id TEXT PRIMARY KEY,  -- UUID v4
  username TEXT NOT NULL UNIQUE,
  email TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,  -- bcryptハッシュ
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  last_login_at INTEGER
);

CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
```

**sessions テーブル**（オプション、将来のセッション管理用）:

```sql
CREATE TABLE IF NOT EXISTS sessions (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  token_hash TEXT NOT NULL,
  expires_at INTEGER NOT NULL,
  created_at INTEGER NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_sessions_user_id ON sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_sessions_expires_at ON sessions(expires_at);
```

#### 4.2.2 既存テーブルの変更

すべてのユーザー固有データテーブルに `user_id` カラムを追加：

**words テーブル**:

```sql
ALTER TABLE words ADD COLUMN user_id TEXT;
CREATE INDEX IF NOT EXISTS idx_words_user_id ON words(user_id);
```

**aggregated_stats テーブル**:

```sql
-- id = 1 の制約を削除し、user_idベースに変更
ALTER TABLE aggregated_stats ADD COLUMN user_id TEXT;
CREATE INDEX IF NOT EXISTS idx_aggregated_stats_user_id ON aggregated_stats(user_id);
```

**settings テーブル**:

```sql
ALTER TABLE settings ADD COLUMN user_id TEXT;
CREATE INDEX IF NOT EXISTS idx_settings_user_id ON settings(user_id);
```

**game_scores テーブル**:

```sql
ALTER TABLE game_scores ADD COLUMN user_id TEXT;
CREATE INDEX IF NOT EXISTS idx_game_scores_user_id ON game_scores(user_id);
```

**user_presets テーブル**:

```sql
ALTER TABLE user_presets ADD COLUMN user_id TEXT;
CREATE INDEX IF NOT EXISTS idx_user_presets_user_id ON user_presets(user_id);
```

**preset_words テーブル**:

- 変更不要（システムプリセット用）

### 4.3 APIエンドポイント追加

#### 4.3.1 認証エンドポイント

```
POST   /api/auth/signup      - 新規ユーザー登録
POST   /api/auth/login       - ログイン
POST   /api/auth/logout      - ログアウト
GET    /api/auth/me           - 現在のユーザー情報取得
PUT    /api/auth/profile      - プロフィール更新
POST   /api/auth/verify-token - トークン検証
```

#### 4.3.2 データ移行エンドポイント

```
POST   /api/migration/import  - ローカルデータのインポート
GET    /api/migration/status  - 移行状態の確認
```

### 4.4 ミドルウェア実装

#### 4.4.1 認証ミドルウェア

```typescript
// src/server/auth.ts を実装
;-JWTトークンの検証 - ユーザー情報の取得 - 認証状態のコンテキストへの追加
```

#### 4.4.2 認証必須ミドルウェア

```typescript
// 認証が必要なエンドポイントに適用
;-認証チェック - 未認証の場合は401エラーを返す
```

### 4.5 フロントエンド実装

#### 4.5.1 認証フロー

- サインアップ画面
- ログイン画面
- ログアウト機能
- 認証状態管理（Context APIまたはZustand）

#### 4.5.2 データ移行UI

- 移行オプションの表示
- 移行プログレス表示
- 移行完了通知

---

## 5. データモデル設計

### 5.1 ユーザーモデル

```typescript
interface User {
  id: string // UUID v4
  username: string // ユニーク、3-30文字
  email: string // ユニーク、有効なメール形式
  passwordHash: string // bcryptハッシュ（サーバー側のみ）
  createdAt: number // タイムスタンプ
  updatedAt: number // タイムスタンプ
  lastLoginAt?: number // タイムスタンプ（オプション）
}
```

### 5.2 認証トークンモデル

```typescript
interface AuthToken {
  userId: string
  username: string
  email: string
  iat: number // 発行時刻
  exp: number // 有効期限
}
```

### 5.3 データリレーション

```
users (1) ──< (N) words
users (1) ──< (1) aggregated_stats
users (1) ──< (1) settings
users (1) ──< (N) game_scores
users (1) ──< (N) user_presets
```

---

## 6. セキュリティ要件

### 6.1 パスワードセキュリティ

- **ハッシュ化**: bcrypt（コストファクター: 10以上）
- **ソルト**: bcryptが自動生成
- **最小長**: 8文字
- **複雑さ**: 英数字と記号を含む（推奨）

### 6.2 トークンセキュリティ

- **署名**: HS256（シークレットキーは環境変数で管理）
- **有効期限**: 24時間（通常）、30日（「ログイン状態を保持」）
- **保存方法**:
  - オプション1: HTTP-only Cookie（推奨、XSS対策）
  - オプション2: LocalStorage（実装が簡単、XSSリスクあり）

### 6.3 APIセキュリティ

- **認証必須エンドポイント**: すべてのデータ操作エンドポイント
- **認証不要エンドポイント**:
  - `POST /api/auth/signup`
  - `POST /api/auth/login`
  - `GET /api/presets`（システムプリセットは公開）

### 6.4 データアクセス制御

- **ユーザーIDによるフィルタリング**: すべてのクエリで必須
- **SQLインジェクション対策**: パラメータ化クエリの使用
- **レート制限**: 将来対応（認証エンドポイント）

---

## 7. ユーザー体験設計

### 7.1 初回ユーザーフロー

1. **アプリ起動**
   - 認証状態を確認
   - 未認証の場合、ログイン/サインアップ画面を表示

2. **サインアップ**
   - シンプルなフォーム
   - リアルタイムバリデーション
   - 成功後、自動ログイン

3. **データ移行オプション**
   - ローカルデータが存在する場合、移行オプションを表示
   - 「今すぐ移行」「後で移行」「移行しない」の選択肢

### 7.2 既存ユーザーフロー

1. **ログイン**
   - ユーザー名/メールアドレスとパスワード
   - 「ログイン状態を保持」チェックボックス

2. **アプリ使用**
   - 既存のUXを維持
   - 認証状態はバックグラウンドで管理

### 7.3 認証状態の管理

- **自動ログアウト**: トークン有効期限切れ時
- **セッション復元**: ページリロード時も認証状態を維持
- **ログアウト**: 明示的なログアウトボタン

### 7.4 エラーハンドリング

- **認証エラー**: 分かりやすいエラーメッセージ
- **ネットワークエラー**: リトライ機能
- **トークン期限切れ**: 自動ログアウトと再ログイン促し

---

## 8. 移行戦略

### 8.1 既存データの移行

#### フェーズ1: データベーススキーマ変更

1. `users` テーブルを作成
2. 既存テーブルに `user_id` カラムを追加（NULL許可）
3. インデックスを作成

#### フェーズ2: デフォルトユーザーの作成

- 既存データを「匿名ユーザー」に紐付け
- または、初回ログイン時に移行オプションを提供

#### フェーズ3: データ移行機能の実装

- ローカルデータ（IndexedDB）からクラウドへの移行
- バッチ処理で大量データを移行

### 8.2 段階的ロールアウト

1. **Phase 1: 認証システム実装**
   - ユーザー登録・ログイン機能
   - データベーススキーマ変更

2. **Phase 2: データ分離実装**
   - APIエンドポイントの修正
   - ユーザーIDによるフィルタリング

3. **Phase 3: データ移行機能**
   - ローカルデータのクラウド移行
   - 既存ユーザーへの案内

4. **Phase 4: UI実装**
   - 認証画面
   - プロフィール管理画面

---

## 9. 実装ロードマップ

### 9.1 Phase 1: 基盤実装（2-3週間）

**データベース**:

- [ ] `users` テーブルの作成マイグレーション
- [ ] 既存テーブルに `user_id` カラム追加マイグレーション
- [ ] インデックスの作成

**バックエンド**:

- [ ] JWTライブラリの導入
- [ ] 認証ミドルウェアの実装
- [ ] 認証エンドポイントの実装（signup, login, logout）
- [ ] パスワードハッシュ化の実装

**フロントエンド**:

- [ ] 認証状態管理（Context/Zustand）
- [ ] サインアップ画面
- [ ] ログイン画面
- [ ] ログアウト機能

### 9.2 Phase 2: データ分離（2-3週間）

**バックエンド**:

- [ ] すべてのAPIエンドポイントに認証ミドルウェアを適用
- [ ] ユーザーIDによるデータフィルタリングの実装
- [ ] データ作成時のユーザーID自動紐付け

**テスト**:

- [ ] ユーザー間のデータ分離テスト
- [ ] 認証エラーハンドリングのテスト

### 9.3 Phase 3: データ移行（1-2週間）

**バックエンド**:

- [ ] データ移行エンドポイントの実装
- [ ] バッチ処理の実装

**フロントエンド**:

- [ ] データ移行UIの実装
- [ ] 移行プログレス表示

### 9.4 Phase 4: UI/UX改善（1週間）

**フロントエンド**:

- [ ] プロフィール管理画面
- [ ] 認証状態の視覚的フィードバック
- [ ] エラーメッセージの改善

**ドキュメント**:

- [ ] ユーザーガイドの更新
- [ ] 開発者向けドキュメントの更新

---

## 10. 成功指標（KPI）

### 10.1 機能指標

- **ユーザー登録率**: 新規訪問者のうち、サインアップ完了した割合
- **ログイン成功率**: ログイン試行のうち、成功した割合
- **データ移行率**: 既存ユーザーのうち、データ移行を完了した割合

### 10.2 パフォーマンス指標

- **認証レスポンス時間**: ログイン/サインアップの平均レスポンス時間（目標: <500ms）
- **APIレスポンス時間**: 認証後のAPI呼び出しの平均レスポンス時間（目標: <200ms）

### 10.3 セキュリティ指標

- **認証エラー率**: 認証試行のうち、エラーが発生した割合（目標: <1%）
- **セキュリティインシデント**: データ漏洩や不正アクセスの発生件数（目標: 0件）

### 10.4 ユーザー満足度指標

- **ユーザー離脱率**: サインアップ後、1週間以内に離脱した割合
- **機能利用率**: ログインユーザーのうち、主要機能を使用した割合

---

## 11. リスクと対策

### 11.1 技術的リスク

| リスク                           | 影響度 | 対策                                     |
| -------------------------------- | ------ | ---------------------------------------- |
| データ移行時のデータ損失         | 高     | バックアップ機能、移行前の確認プロセス   |
| 認証システムのセキュリティ脆弱性 | 高     | セキュリティ監査、ペネトレーションテスト |
| パフォーマンス低下               | 中     | インデックスの最適化、クエリの最適化     |
| 既存データとの互換性問題         | 中     | 段階的移行、ロールバック計画             |

### 11.2 ユーザー体験リスク

| リスク                           | 影響度 | 対策                           |
| -------------------------------- | ------ | ------------------------------ |
| 認証フローの複雑さによる離脱     | 中     | シンプルなUI、明確なガイダンス |
| 既存ユーザーのデータ移行の煩雑さ | 中     | 自動移行機能、詳細な説明       |
| 認証エラー時の混乱               | 低     | 分かりやすいエラーメッセージ   |

### 11.3 運用リスク

| リスク                                   | 影響度 | 対策                                             |
| ---------------------------------------- | ------ | ------------------------------------------------ |
| データベーススキーマ変更時のダウンタイム | 中     | メンテナンスウィンドウの設定、段階的移行         |
| 認証トークンの管理ミス                   | 高     | 環境変数の適切な管理、シークレットローテーション |

---

## 12. 将来の拡張

### 12.1 認証機能の拡張

- **ソーシャルログイン**: OAuth（Google、GitHub、Twitter等）
- **パスワードリセット**: メール認証によるパスワードリセット
- **2要素認証（2FA）**: TOTPベースの2FA
- **セッション管理**: アクティブセッションの一覧・管理

### 12.2 ユーザー機能の拡張

- **プロフィール画像**: アバター画像のアップロード
- **ユーザー統計**: 公開可能な統計情報
- **フレンド機能**: ユーザー間のフォロー・フォロワー機能
- **ランキング**: グローバル/フレンド間のランキング

### 12.3 データ共有機能

- **プリセット共有**: ユーザープリセットの公開・共有
- **統計データの共有**: 学習進捗の共有
- **エクスポート/インポート**: データのバックアップ・復元

---

## 13. 参考資料

### 13.1 技術ドキュメント

- [JWT仕様](https://datatracker.ietf.org/doc/html/rfc7519)
- [bcrypt仕様](https://en.wikipedia.org/wiki/Bcrypt)
- [Tursoデータベースドキュメント](https://docs.turso.tech/)
- [Honoフレームワークドキュメント](https://hono.dev/)

### 13.2 セキュリティガイドライン

- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [OWASP Session Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)

---

## 14. 承認とレビュー

### 14.1 レビュアー

- プロダクトマネージャー
- テックリード
- セキュリティエンジニア
- UXデザイナー

### 14.2 承認プロセス

1. 初稿レビュー
2. フィードバック反映
3. 技術的実現可能性の確認
4. セキュリティレビュー
5. 最終承認

---

**文書バージョン**: 1.0  
**最終更新日**: 2024-12-XX  
**作成者**: TypeFlow開発チーム
