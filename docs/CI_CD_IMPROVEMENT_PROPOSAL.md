# CI/CD強化提案書

## 現状分析

### 既存の設定
- ✅ TypeScript設定 (`tsconfig.json`)
- ✅ ESLint設定（`package.json`にlintスクリプトあり）
- ✅ ビルドスクリプト (`vite build`)
- ✅ 型チェックスクリプト (`tsc -b`)
- ✅ Cloudflare Workersデプロイ設定 (`wrangler.toml`)
- ✅ Renderデプロイ設定 (`render.yaml`)

### 不足している要素
- ❌ テストフレームワーク（Vitest等）
- ❌ GitHub Actions CI/CDパイプライン
- ❌ Prettier設定（コードフォーマット）
- ❌ コードカバレッジ計測
- ❌ 依存関係の脆弱性チェック
- ❌ ビルドの自動検証
- ❌ データベースマイグレーションの検証
- ❌ リリース自動化

## 提案する改善策

### 1. テストフレームワークの導入（優先度: 高）

#### 1.1 Vitestの導入
- **理由**: Viteベースのプロジェクトなので、Vitestが最適
- **対象**: ユニットテスト、統合テスト
- **実装内容**:
  - Vitestのインストールと設定
  - テスト用のディレクトリ構造の作成 (`src/__tests__/` または `tests/`)
  - 主要なユーティリティ関数のテスト作成
  - React Testing Libraryの導入（コンポーネントテスト用）

#### 1.2 テスト対象の優先順位
1. **ユーティリティ関数** (`src/lib/`)
   - `japanese-utils.ts`
   - `romaji-utils.ts`
   - `adaptive-time-utils.ts`
   - `csv-utils.ts`
   - `srs-utils.ts`
   - `skill-check-utils.ts`
2. **カスタムフック** (`src/hooks/`)
   - `useGame.ts`
   - `useSettings.ts`
   - `useWords.ts`
   - `useTypingAnalytics.ts`
3. **サーバーサイド** (`src/server/`)
   - APIエンドポイントのテスト
   - データベース操作のテスト

### 2. GitHub Actions CI/CDパイプライン（優先度: 高）

#### 2.1 基本的なCIワークフロー
```yaml
# .github/workflows/ci.yml
- プッシュ/プルリクエスト時に自動実行
- ジョブ:
  1. Lintチェック
  2. 型チェック
  3. テスト実行
  4. ビルド検証
  5. コードカバレッジレポート生成
```

#### 2.2 デプロイワークフロー
```yaml
# .github/workflows/deploy.yml
- mainブランチへのマージ時に自動実行
- ジョブ:
  1. 本番ビルド
  2. Cloudflare Workersへのデプロイ
  3. デプロイ後のヘルスチェック
```

#### 2.3 セキュリティチェック
```yaml
# .github/workflows/security.yml
- 週次実行 + プルリクエスト時
- ジョブ:
  1. 依存関係の脆弱性スキャン (npm audit / bun audit)
  2. Dependabotの設定
  3. コードセキュリティスキャン
```

### 3. コード品質ツールの強化（優先度: 中）

#### 3.1 Prettierの導入
- **理由**: コードフォーマットの統一
- **設定ファイル**: `.prettierrc.json`, `.prettierignore`
- **統合**: ESLintとPrettierの統合 (`eslint-config-prettier`)

#### 3.2 ESLint設定の明確化
- ESLint設定ファイルの作成（フラット設定形式）
- ルールの最適化
- 自動修正可能なルールの設定

#### 3.3 コミット前フック（Husky + lint-staged）
- コミット前に自動でlintとフォーマットを実行
- テストが失敗する場合はコミットをブロック

### 4. コードカバレッジ（優先度: 中）

#### 4.1 カバレッジ計測
- Vitestのカバレッジ機能を使用
- カバレッジレポートの生成（HTML、LCOV形式）
- カバレッジ閾値の設定（例: 80%以上）

#### 4.2 カバレッジレポートの可視化
- CodecovまたはCoverallsとの統合
- プルリクエストにカバレッジコメントを自動追加

### 5. データベースマイグレーション検証（優先度: 中）

#### 5.1 マイグレーション検証
- マイグレーションファイルの構文チェック
- マイグレーションの前後でスキーマの整合性チェック
- テスト環境でのマイグレーション実行検証

### 6. リリース自動化（優先度: 低）

#### 6.1 セマンティックバージョニング
- コミットメッセージに基づく自動バージョン管理
- タグの自動生成

#### 6.2 リリースノート自動生成
- CHANGELOG.mdの自動更新
- GitHubリリースの自動作成

### 7. パフォーマンステスト（優先度: 低）

#### 7.1 ビルドサイズ監視
- バンドルサイズの監視
- サイズ増加の警告

#### 7.2 Lighthouse CI
- パフォーマンススコアの監視
- アクセシビリティチェック

## 実装の優先順位

### Phase 1: 基盤構築（即座に実装）
1. ✅ Vitestの導入と基本設定
2. ✅ GitHub Actions CIワークフローの作成
3. ✅ Prettierの導入
4. ✅ ESLint設定ファイルの明確化

### Phase 2: テスト拡充（1-2週間）
1. ✅ 主要ユーティリティ関数のテスト作成
2. ✅ カスタムフックのテスト作成
3. ✅ コードカバレッジの設定

### Phase 3: デプロイ自動化（2-3週間）
1. ✅ デプロイワークフローの作成
2. ✅ セキュリティチェックの追加
3. ✅ マイグレーション検証の追加

### Phase 4: 高度な機能（3-4週間）
1. ✅ リリース自動化
2. ✅ パフォーマンステスト
3. ✅ カバレッジレポートの可視化

## 期待される効果

### 開発効率の向上
- 自動テストにより、リグレッションを早期発見
- コードレビューの負担軽減
- デプロイプロセスの自動化

### 品質の向上
- コードカバレッジの向上
- バグの早期発見
- コードスタイルの統一

### 保守性の向上
- テストがドキュメントとして機能
- リファクタリングの安全性向上
- 依存関係の脆弱性管理

## 次のステップ

1. この提案書のレビューと承認
2. Phase 1の実装開始
3. 段階的な導入とフィードバック収集

